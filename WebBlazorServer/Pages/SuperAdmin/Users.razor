@page "/superadmin/users"
@inherits SuperAdminLayout
@layout SuperAdminLayout

@inject IJSRuntime JSRuntime
@inject IAppControllerAsync<UserAuthenticated> _appctrl
@inject IMembershipGatewayManager _memberservices
@inject IAppSettingsManager<TemplateSettings>  _settings
@inject NavigationManager NavigationManager
@inject HttpClient _httpclient

<BreadCrumbView IsHome="false" HomeURL="/superadmin/home" PageTitle="Gerenciamento de Usuários" ></BreadCrumbView>

       <div id="kt_content_container" class="d-flex flex-column-fluid align-items-start container-xxl">
            <div class="content flex-row-fluid" id="kt_content">        
                <div class="">        

                    @if (view != null)
                    {
                        <div style="display:@view.SearchingState">

                            <div class="row gy-5 g-xl-10">

                                <div class="col-xl-4">                                
                                    <div class="card card-flush h-xl-100">								      
								        <div class="card-header pt-7">
									  
									        <h3 class="card-title align-items-start flex-column">
										        <span class="card-label fw-bold text-dark">Pesquisar</span>										
									        </h3>									        
									       
                                        </div>
                                           
                                        <div class="card-body">
										         <div class="form-group">
                                                    <label class="form-label" >E-mail:</label>
                                                    <input type="email" @bind-value="view.param.pEmail" class="form-control"
                                                       placeholder="Pesquisar por e-mail">
                                                </div>

                                                 <div class="form-group">
                                                    <label class="form-label" >User Name:</label>
                                                    <input type="text" maxlength="20" @bind-value="view.param.pUserName" class="form-control"
                                                       placeholder="Pesquisar por username">
                                                </div>

                                                <div class="form-group">
                                                        <label class="form-label">Perfil:</label>
                                                        @if (view.listRoles != null & view.listRoles.Count > 0)
                                                        {
                                                             <SelectList TItem="RoleList"
                                                                                TValue="Int64"
                                                                                Data="@view.listRoles"
                                                                                TextField="@((item)=>item.RoleName)"
                                                                                ValueField="@((item)=>item.RoleID)"
                                                                                @bind-SelectedValue="@view.param.pRoleID"></SelectList>
                                      
                                                        }

                                                </div>

                                                <p class="field" style="padding-top:10px">

                                                    <TaskButton @ref="searchbtn" OnClick="OnSearch" Title="Pesquisar"
                                                                Description="Clique aqui buscar usuários."
                                                                ActionLabel="Pesquisando...">
                                                    </TaskButton>

                                                </p>									       
									    
                                                 <p class="field" style="padding-top:10px">
                                                     <TaskButton @ref="newbtn" OnClick="OnNew" Title="Novo Usuário" Class="dark"
                                                          Description="Clique aqui criar o novo usuário."
                                                          ActionLabel="Inserindo...">
                                                        </TaskButton>

                                                 </p>
                                           </div>
								        </div>
                                     </div>
                                                            
                                <div class="col-xl-8">

                                    <div class="card card-flush h-xl-100">
										
										<div class="card-header pt-7">
											
											<h3 class="card-title align-items-start flex-column">
												<span class="card-label fw-bold text-dark">Resultado da Busca</span>												
											</h3>
                                        </div>

                                        <div class="card-body">
                                            @if (view.searchresult != null)
                                            {
                                                @if (view.searchresult.Count > 0)
                                                {
                                                      <DataGrid TItem="UserSearchResult" Data="@view.searchresult"  Responsive  ShowPager >                                                                                                                                      
                                                        <DataGridColumns>
                                            
                                                            <DataGridColumn Field="@nameof(UserSearchResult.Email)" Caption="E-mail" />
                                                 
                                                             <DataGridColumn Field="@nameof(UserSearchResult.IsActive)" Caption="Ativo ?" >
                                                                <DisplayTemplate>
                                                                            @{
                                                                                UserSearchResult user = (context as UserSearchResult);
                                                                                if (user.IsActive == 1)
                                                                                {
                                                                                        <span>SIM</span>
                                                                                }
                                                                                else
                                                                                {
                                                                                        <span>NÃO</span>
                                                                                }
                                                                            }                                            
                                                                </DisplayTemplate>
                                                            </DataGridColumn>

                                                               <DataGridColumn Field="@nameof(UserSearchResult.IsLocked)" Caption="Bloqueado ?" >
                                                                <DisplayTemplate>
                                                                          @{
                                                                                UserSearchResult user = (context as UserSearchResult);
                                                                                if (user.IsLocked == 1)
                                                                                {
                                                                                        <span>SIM</span>
                                                                                }
                                                                                else
                                                                                {
                                                                                        <span>NÃO</span>
                                                                                }
                                                                            }                                           
                                                                </DisplayTemplate>
                                                            </DataGridColumn>                                              

                                                             <DataGridColumn Field="@nameof(UserSearchResult.UserID)" Caption="Detalhes" >
                                                                <DisplayTemplate>
                                                                      @{
                                                                            UserSearchResult user = (context as UserSearchResult);

                                                                            <span class="svg-icon svg-icon-2" @onclick="(() => OnDetClick(user.UserID))">
														                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
															                        <rect opacity="0.5" x="7" y="2" width="14" height="16" rx="3" fill="currentColor"></rect>
															                        <rect x="3" y="6" width="14" height="16" rx="3" fill="currentColor"></rect>
														                        </svg>
													                        </span>                                                                             

                                                                        }
                                                    
                                                                </DisplayTemplate>
                                                            </DataGridColumn>
                                            
                                                            </DataGridColumns>
                                      
                                                        </DataGrid>

                                                }
                                                else
                                                {
                                                    <p> Nenhum registro encontrado </p>
                                                }
                                              }
                                         
                                        </div>

                                    </div>
                                                                  

                                </div>

                           
                             </div>

                        </div>                       

                        <div style="display:@view.EditingState">
                            
                            <div class="mr-2">
								<button type="button" class="btn btn-light-primary me-3" data-kt-stepper-action="previous" @onclick="Back">								
								<span class="svg-icon svg-icon-4 me-1">
									<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
										<rect opacity="0.5" x="6" y="11" width="13" height="2" rx="1" fill="currentColor"></rect>
										<path d="M8.56569 11.4343L12.75 7.25C13.1642 6.83579 13.1642 6.16421 12.75 5.75C12.3358 5.33579 11.6642 5.33579 11.25 5.75L5.70711 11.2929C5.31658 11.6834 5.31658 12.3166 5.70711 12.7071L11.25 18.25C11.6642 18.6642 12.3358 18.6642 12.75 18.25C13.1642 17.8358 13.1642 17.1642 12.75 16.75L8.56569 12.5657C8.25327 12.2533 8.25327 11.7467 8.56569 11.4343Z" fill="currentColor"></path>
									</svg>
								</span>
								Voltar </button>
							</div>

                            @if (!view.Inserting)
                            {

                                <div class="row gy-5 g-xl-10">

                                    <div class="col-xl-8">                                
                                        <div class="card card-flush h-xl-100">								      
		                                    <div class="card-header pt-7">
									  
			                                    <h3 class="card-title align-items-start flex-column">
				                                    <span class="card-label fw-bold text-dark">Dados do Usuário</span>										
			                                    </h3>									        
									       
                                            </div>
                                           
                                            <div class="card-body">										            
                                                    
                                                    <div class="row">
                                                        <div class="col-md-12">                                                            

                                                            <div class="form-group">
                                                                <label class="form-label" for="name">UserName:</label>
                                                                <input type="text" disabled class="form-control field" value="@view.model.UserName" />

                                                            </div>
                                                        </div>
                                                    </div>

                                                   <div class="row">
                                                        <div class="col-md-12">
                                                            <div class="form-group">
                                                                <label class="form-label"  for="email">E-mail:</label>
                                                                <input type="text" disabled class="form-control field" value="@view.model.Email" />
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <div class="form-group">
                                                                <label class="form-label" for="email">Role:</label>
                                                
                                                                    @if (view.listRoles != null & view.listRoles.Count > 0)
                                                                    {
                                                                        <SelectList TItem="RoleList"
                                                                            TValue="Int64"
                                                                            Data="@view.listRoles"
                                                                            TextField="@((item)=>item.RoleName)"
                                                                            ValueField="@((item)=>item.RoleID)"
                                                                            @bind-SelectedValue="@view.model.RoleID"></SelectList>
                                                        
                                                                    }
                                                                </div>
                                                        </div>
                                                    </div>

                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label class="form-label" for="name">Create Date</label>
                                                                <input type="text" disabled class="form-control field" value="@view.model.CreateDate" />

                                                            </div>
                                                        </div>

                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label class="form-label" for="email">last Login Date</label>
                                                                <input type="text" disabled class="form-control field" value="@view.model.LastLoginDate" />
                                                            </div>
                                                        </div>

                                                    </div>

                                                     <div class="row">
                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label" for="name">Last Login IP</label>
                                                                <input type="text" disabled class="form-control field" value="@view.model.LastLoginIP" />

                                                            </div>
                                                        </div>

                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label" for="email">LoginCounter</label>
                                                                <input type="text" disabled class="form-control field" value="@view.model.LoginCounter" />
                                                            </div>
                                                        </div>

                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label" for="email">Password Recovery Code</label>
                                                                <input type="text" disabled class="form-control field" value="@view.model.PasswordRecoveryCode" />
                                                            </div>
                                                        </div>

                                                    </div>

                                               
                                            </div>
		                                </div>
                                    </div>
                                                            
                                    <div class="col-xl-4">

                                        <div class="card card-flush h-xl-100">
												                               

                                            <div class="card-body">
                                                                                                             
                                                    <div class="row">
                                                        <div class="col-md-12">

                                                            <div class="me-7 mb-4">
											                    <div class="symbol symbol-100px symbol-lg-160px symbol-fixed position-relative">
												                    <img src="@view.model.ProfileImageURL" alt="image">												                   
											                    </div>
										                    </div>
                                                           
                                                        </div>
                                                    </div>

                                                    <div class="row" style="padding-top:20px">
                                                        <div class="col-md-12">
                                                            <div class="form-group">
                                                                <label class="form-label" for="name">Status do Usuário:</label>


                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="row" style="padding-top:20px">
                                                        <div class="col-md-12">
                                                            <div class="form-group">
                                                                <label class="form-label" for="name">Active:</label>
                                                                    <Switch TValue="bool" @bind-Checked="@view.isUserActive"></Switch>
                                             
                                                            </div>

                                                        </div>
                                                    </div>

                                                    <div class="row" style="padding-top:20px">
                                                        <div class="col-md-12">
                                                            <div class="form-group">
                                                                <label class="form-label" for="name">Locked:</label>
                                                                    <Switch TValue="bool" @bind-Checked="@view.isUserLocked"></Switch>
                                             
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <p class="field" style="padding-top:10px">

                                                        <TaskButton @ref="statebtn" Title="Atualizar Status" OnClick="OnChangeState"
                                                                        Description="Clique aqui para altualizar os estados de Ativo e Bloqueado."
                                                                        ActionLabel="Atualizando...">
                                                        </TaskButton>

                                                    </p>
                                                   
                                         
                                            </div>

                                        </div>
                                                                  

                                    </div>

                           
                                 </div>
                                 
                            }
                            else
                            {   
                                  <div class="row gy-5 g-xl-10">

                                        <div class="col-xl-10">                                
                                            <div class="card card-flush h-xl-100">								      
		                                        <div class="card-header pt-7">
									  
			                                        <h3 class="card-title align-items-start flex-column">
				                                        <span class="card-label fw-bold text-dark">Novo Usuário</span>										
			                                        </h3>									        
									       
                                                </div>
                                           
                                                <div class="card-body">
										                                                                                                                                
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                    <div class="">
                                                                        <label class="form-label" >Role:</label>
                                                                        @if (view.listRoles != null & view.listRoles.Count > 0)
                                                                        {
                                                                                <SelectList TItem="RoleList"
                                                                                    TValue="Int64"
                                                                                    Data="@view.listRoles"
                                                                                    TextField="@((item)=>item.RoleName)"
                                                                                    ValueField="@((item)=>item.RoleID)"
                                                                                    @bind-SelectedValue="@view.newModel.RoleID"></SelectList>
                                                
                                                                        }                                                                       
                                                                        <label class="form-label validation_field">@view.GetSummaryMessage("RoleID") </label>

                                                                 </div>
                                                            </div>
                                                         </div>
                                                                        
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <div class="">
                                                                    <label class="form-label" >E-mail :</label>
                                                                    <input type="text" @bind-value="@view.newModel.Email" maxlength="100" class="form-control" />                                                                    
                                                                    <label class="form-label validation_field">@view.GetSummaryMessage("Email") </label>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <div class="">
                                                                    <label class="form-label" >Nome de Usuário :</label>
                                                                    <input type="text" @bind-value="@view.newModel.UserName" maxlength="50" class="form-control" />                                                                    
                                                                    <label class="form-label validation_field">@view.GetSummaryMessage("UserName") </label>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="row" >
                                                            <div class="col-md-6">
                                                                <div class="">
                                                                    <label class="form-label" >Senha :</label>
                                                                    <input type="password" @bind-value="@view.newModel.Password" maxlength="8" class="form-control" />                                                                    
                                                                    <label class="form-label validation_field">@view.GetSummaryMessage("Password") </label>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <p class="field" style="padding-top:10px">

                                                            <TaskButton @ref="savenewbtn" OnClick="OnCreate" Title="Criar Usuário"
                                                                        Description="Clique aqui para salvar os dados do novo usuário."
                                                                        ActionLabel="Salvando...">
                                                            </TaskButton>

                                                        </p>  			                  
			                                                                                                                                       
                                               
                                                 </div>
		                                    </div>
                                        </div>                                                               

                           
                                </div>
                                

                                    
                            }                         

                     </div>
                    }
                    else
                    {
                        <h5>Carregando a página. Aguarde...</h5>

                    }
                </div>
            </div>
        </div>


<MessageBox @ref="msgbox"></MessageBox>

<MessageBox @ref="msgbox_create" 
    ButtonNo="true" ButtonYes="true" ButtonOK="false" 
    OnClickYes="OnNew" >
</MessageBox>

<TaskLoading @ref="loading" Title="Carregando dados. Aguarde..."></TaskLoading>

@code {


    private MessageBox msgbox;
    private MessageBox msgbox_create;
    private TaskLoading loading;
    private TaskButton searchbtn;
    private TaskButton statebtn;
    private TaskButton newbtn;
    private TaskButton savenewbtn;


    //

    private UserAuthenticated LoggedUser;
    private UserViewModel view; 

    //

    private async Task InitResources()
    {
        _settings.LoadSettings(_httpclient);
        ((TemplateAppController)_appctrl).Settings = _settings.Settings;

        if (await _appctrl.IsAuthenticated())
        {
            LoggedUser = _appctrl.UserInfo;
            _memberservices.Init(_httpclient,_settings.Settings.ServiceURL,LoggedUser.Token);
            view = new UserViewModel((_memberservices as MembershipGateway) ,LoggedUser); 
        }

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        if (firstRender)
        {
            await InitResources();
            await view.InitializeModels(); 
            StateHasChanged();
        }
    }

    public async Task OnSearch()
    {
        searchbtn.Begin(); 
        await view.Search();

        if (!view.ExecutionStatus.Status)
        {
           await msgbox.ShowDialog("Erro ao efetuar pesquisa", view.ExecutionStatus.Error.Message);
        }

        searchbtn.End();
    }

    public void OnNew()
    {

        view.InitNew(); 
        StateHasChanged();
    }

    public async Task OnGet(object id)
    {
        await loading.Begin() ;

        await view.Get(id);

        await loading.End();

        if (!view.ExecutionStatus.Status)
        {
           await msgbox.ShowDialog("Erro ao retornar os dados", view.ExecutionStatus.Error.Message);
        }
        else
        {
            view.InitEdit(); 

        }

        StateHasChanged();
    }

    public async Task OnChangeState()
    {        
        statebtn.Begin(); 
        await view.ChangeState();

        if (!view.ExecutionStatus.Status)
        {
            await msgbox.ShowDialog("Erro ao alterar o status do usuário.", view.ExecutionStatus.Error.Message);
        }
        else
        {
            await msgbox.ShowDialog("Aviso", "O status do usuário foi alterado.");
        }

        statebtn.End();

    }

    public async Task OnCreate()
    {        
         savenewbtn.Begin(); 
       
         await view.CreateNew(); 

        if (!view.ExecutionStatus.Status)
        {
            await msgbox.ShowDialog("Erro criar novo usuário.", view.ExecutionStatus.Error.Message);
        }
        else
        {
            this.Back();
           await  msgbox_create.ShowDialog("Sucesso!", "O novo usuário foi criado com sucesso. Deseja continuar inserindo ?");

        }

        savenewbtn.End();

    }

 
    public async Task OnDetClick(object args)
    {        
        await OnGet(args);

    }

    public void Back()
    {
        view.BackToSearch(); 
        StateHasChanged();

    }

    public void GoHome()
    {
        string url = _appctrl.UserInfo.HomeURL;
        NavigationManager.NavigateTo(url);

    }


    //public string GetImageUrl(string filename)
    //{
    //    string ret = "";

    //    ret = ((TemplateAppController)_appctrl).GetProfileImageURL(filename);

    //    return ret;
    //}


}