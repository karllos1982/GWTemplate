@page "/superadmin/instances"
@inherits SuperAdminLayout
@layout SuperAdminLayout

@inject IJSRuntime JSRuntime
@inject IAppControllerAsync<UserAuthenticated> _appctrl
@inject IMembershipGatewayManager _memberservices
@inject IAuthGatewayManager _appservices
@inject IAppSettings _settings
@inject NavigationManager NavigationManager
@inject HttpClient _httpclient

<BreadCrumbView IsHome="false" HomeURL="/superadmin/home" PageTitle="Instances"></BreadCrumbView>

<div id="kt_content_container" class="d-flex flex-column-fluid align-items-start container-xxl">
    <div class="content flex-row-fluid" id="kt_content">
        <div class="">

            @if (view != null)
            {
                <div style="display:@view.SearchingState">

                    <div class="row gy-5 g-xl-10">

                        <div class="col-xl-4">
                            <div class="card card-flush h-xl-100">
                                <div class="card-header pt-7">

                                    <h3 class="card-title align-items-start flex-column">
                                        <span class="card-label fw-bold text-dark">Search</span>
                                    </h3>

                                </div>

                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Search by Name:</label>
                                        <input type="text" @bind-value="view.param.pInstanceName" class="form-control"
                                           placeholder="Search by Instance Name ">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Search by Type Name:</label>
                                        <input type="text" maxlength="20" @bind-value="view.param.pInstanceTypeName" class="form-control"
                                           placeholder="Search by Instance Type Name">
                                    </div>

                                    <p class="field" style="padding-top:10px">

                                        <TaskButton @ref="searchbtn" OnClick="OnSearch" Title="Go"
                                                Description="Click here to search." ReadOnly=!view.Permissions.AllowRead
                                                ActionLabel="Searching...">
                                        </TaskButton>

                                    </p>

                                    <p class="field" style="padding-top:10px">
                                        <TaskButton @ref="newbtn" OnClick="OnNew" Title="New Instance" Class="dark"
                                                Description="Click here to create new record." Disabled=""
                                                ReadOnly=!view.Permissions.AllowSave
                                                ActionLabel="Inserting...">
                                        </TaskButton>

                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-8">

                            <div class="card card-flush h-xl-100">

                                <div class="card-header pt-7">

                                    <h3 class="card-title align-items-start flex-column">
                                        <span class="card-label fw-bold text-dark">Search Results </span>
                                    </h3>
                                </div>

                                <div class="card-body">
                                    @if (view.searchresult != null)
                                    {
                                        @if (view.searchresult.Count > 0)
                                        {
                                            <DataGrid TItem="InstanceResult" Data="@view.searchresult" Responsive ShowPager>
                                                <DataGridColumns>

                                                    <DataGridColumn Field="@nameof(InstanceResult.InstanceTypeName)" Caption="Type Name" />
                                                    <DataGridColumn Field="@nameof(InstanceResult.InstanceName)" Caption="Name" />
                                                    
                                                    <DataGridColumn Field="@nameof(InstanceResult.IsActive)" Caption="Is Active">
                                                        <DisplayTemplate>
                                                            @{
                                                                InstanceResult obj = (context as InstanceResult);

                                                                if (obj.IsActive==1)
                                                                {
                                                                    <span> YES </span>
                                                                }
                                                                else
                                                                {
                                                                    <span> NO </span>
                                                                }                                                                
                                                              
                                                            }

                                                        </DisplayTemplate>
                                                    </DataGridColumn>
                                                    

                                                    <DataGridColumn Field="@nameof(InstanceResult.InstanceID)" Caption="Edit">
                                                        <DisplayTemplate>
                                                            @{
                                                                InstanceResult obj = (context as InstanceResult);

                                                                @if (view.Permissions.AllowSave)
                                                                {
                                                                    <IconButton Icon="IconButton.TYPEICONENUM.EDIT"
                                                                     OnClick="()=>OnDetClick(obj.InstanceID)"></IconButton>
                                                                }
                                                            }

                                                        </DisplayTemplate>
                                                    </DataGridColumn>

                                                </DataGridColumns>

                                            </DataGrid>

                                        }
                                        else
                                        {
                                            <p> No records founds </p>
                                        }
                                    }

                                </div>

                            </div>


                        </div>


                    </div>

                </div>

                <div style="display:@view.EditingState">

                    <BackButton OnClick="Back"></BackButton>

                    <div class="row gy-5 g-xl-10">

                        <div class="col-xl-8">
                            <div class="card card-flush h-xl-100">
                                <div class="card-header pt-7">

                                    <h3 class="card-title align-items-start flex-column">
                                        <span class="card-label fw-bold text-dark">Instance Record</span>
                                    </h3>

                                </div>

                                <div class="card-body">

                                    <div class="row">
                                        <div class="col-md-12">

                                            <div class="form-group">
                                                <label class="form-label" for="name">Instance Type Name:</label>
                                                <input type="text" class="form-control field" @bind-value="@view.result.InstanceTypeName" />
                                                <label class="validation_field">@view.GetSummaryMessage("InstanceTypeName") </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label class="form-label" for="email">Instance Name:</label>
                                                <input type="text" class="form-control field" @bind-value="@view.result.InstanceName" />
                                                <label class="validation_field">@view.GetSummaryMessage("InstanceName") </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row" style="padding-top:20px">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label class="form-label" for="name">Active:</label>
                                                <Switch TValue="int" @bind-Checked="@view.result.IsActive"></Switch>

                                            </div>

                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-12">

                                            <p class="field" style="padding-top:10px">

                                                <TaskButton @ref="savenewbtn" OnClick="OnSet" Title="Save"
                                                        Description="Click here to save data."
                                                        ActionLabel="Saving..." ReadOnly=!view.Permissions.AllowSave>
                                                </TaskButton>

                                            </p>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>


                    </div>

                </div>
            }
            else
            {
                <h5>Loading. Wait please...</h5>

            }
        </div>
    </div>
</div>


<MessageBox @ref="msgbox"></MessageBox>

<MessageBox @ref="msgbox_create"
            ButtonNo="true" ButtonYes="true" ButtonOK="false"
            OnClickYes="OnNew">
</MessageBox>

<TaskLoading @ref="loading" Title="Carregando dados. Aguarde..."></TaskLoading>

@code {


    private MessageBox msgbox;
    private MessageBox msgbox_create;
    private TaskLoading loading;
    private TaskButton searchbtn;
    private TaskButton statebtn;
    private TaskButton newbtn;
    private TaskButton savenewbtn;


    //

    private UserAuthenticated LoggedUser;
    private InstanceViewModel view;

    //

    private async Task InitResources()
    {
        ((TemplateAppController)_appctrl).Settings = _settings;

        if (await _appctrl.IsAuthenticated())
        {
            LoggedUser = _appctrl.UserInfo;
            _memberservices.Init(_httpclient, _settings.ServiceURL, LoggedUser.Token);

            view = new InstanceViewModel((_memberservices as MembershipGateway), LoggedUser);

            List<UserPermissions> list = await _appctrl.GetUserPermissions();
            view.Permissions
               = BaseViewModel.SetPermissions(list, "SYSINSTANCE", false);
        }

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        if (firstRender)
        {
            await InitResources();
            await view.InitializeModels();
            StateHasChanged();
        }
    }

    public async Task OnSearch()
    {
        searchbtn.Begin();
        await view.Search();

        if (!view.ExecutionStatus.Status)
        {
            await msgbox.ShowDialog("Erro ao efetuar pesquisa", view.ExecutionStatus.Error.Message);
        }

        searchbtn.End();
    }

    public void OnNew()
    {

        view.InitNew();
        StateHasChanged();
    }

    public async Task OnGet(object id)
    {
        await loading.Begin();

        await view.Get(id);

        await loading.End();

        if (!view.ExecutionStatus.Status)
        {
            await msgbox.ShowDialog("Erro ao retornar os dados", view.ExecutionStatus.Error.Message);
        }
        else
        {
            view.InitEdit();

        }

        StateHasChanged();
    }


    public async Task OnSet()
    {
        savenewbtn.Begin();

        await view.Set();

        if (!view.ExecutionStatus.Status)
        {
            await msgbox.ShowDialog("Erro salvar.", view.ExecutionStatus.Error.Message);
        }
        else
        {
            if (this.view.Inserting)
            {
                await msgbox_create.ShowDialog("Sucesso!", "O Objeto foi salvo com sucesso. Deseja continuar inserindo ?");
            }
            else
            {
                await msgbox.ShowDialog("Sucesso!", "Os dados foram editados com sucesso.");
                this.Back();
            }

        }

        savenewbtn.End();

    }

    public async Task OnDetClick(object id)
    {
        await OnGet(id);

    }

    public void Back()
    {
        view.BackToSearch();
        StateHasChanged();

    }

    public void GoHome()
    {
        string url = _appctrl.UserInfo.HomeURL;
        NavigationManager.NavigateTo(url);

    }



}