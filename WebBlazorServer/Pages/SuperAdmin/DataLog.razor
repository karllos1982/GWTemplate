@page "/superadmin/datalog"
@inherits SuperAdminLayout
@layout SuperAdminLayout


@inject IJSRuntime JSRuntime
@inject IAppControllerAsync<UserAuthenticated> _appctrl
@inject IMembershipGatewayManager _memberservices
@inject IDataCacheGatewayManager _cacheservices
@inject IAppSettings _settings
@inject NavigationManager NavigationManager
@inject HttpClient _httpclient

<BreadCrumbView IsHome="false" HomeURL="/superadmin/home"
                PageTitle=@_PageTitle></BreadCrumbView>

<MessageBox @ref="msgbox"></MessageBox>

<TaskLoading @ref="loading" Title=@_LoadingData_Text></TaskLoading>


   <div id="kt_content_container" class="d-flex flex-column-fluid align-items-start container-xxl">
        <div class="content flex-row-fluid" id="kt_content">        
            <div class="">        

                @if (view != null)
                {
                    <div style="display:@view.SearchingState">

                        <div class="row gy-5 g-xl-10">

                            <div class="col-xl-4">                                
                                <div class="card card-flush h-xl-100">								      
								    <div class="card-header pt-7">
									  
									    <h3 class="card-title align-items-start flex-column">
                                        <span class="card-label fw-bold text-dark">@view.texts.SearchButtonLabel</span>
                                    </h3>									        
									       
                                    </div>
                                           
                                    <div class="card-body">
							             <div class="form-group">
                                        <label class="form-label">@view.texts.SearchByOperationType_Label:</label>

                                                @if (view.listTipoOperacao.Count > 0)
                                                {
                                                        <SelectList TItem="TipoOperacaoValueModel"
                                                                    TValue="string"
                                                                    Data="@view.listTipoOperacao"
                                                                    TextField="@((item)=>item.Text)"
                                                                    ValueField="@((item)=>item.Value)"
                                                                    @bind-SelectedValue="@view.param.pOperation">
                                                        </SelectList>
                                    
                                                }

                                        </div>		
                                        
                                         <div class="form-group">
                                        <label class="form-label">@view.texts.SearchByObject_Label:</label>

                                                @if (view.listTabelas.Count > 0)
                                                {

                                                       <SelectList TItem="TabelasValueModel"
                                                                        TValue="string"
                                                                        Data="@view.listTabelas"
                                                                        TextField="@((item)=>item.Text)"
                                                                        ValueField="@((item)=>item.Value)"
                                                                        @bind-SelectedValue="@view.param.pTableName"></SelectList>
                                      
                                                }
                                          </div>
                                         
                                        <div class="form-group">
                                        <label class="form-label" for="name">@view.texts.SearchByIntervalDate_Label:</label>
                                            <Switch TValue="bool" @bind-Checked="@view.param.SearchByDate"></Switch>
                                
                                        </div>
                                          
                                         @if (view.param.SearchByDate)
                                         {
                                                <div class="form-group">
                                            <span>@view.texts.SearchByInicialDate_Label:</span>
                                                    <DateEdit TValue="DateTime" @bind-Date="@view.param.pDate_Start" />
                                                    <br/>
                                            <span>@view.texts.SearchByFinalDate_Label:</span>
                                                    <DateEdit TValue="DateTime" @bind-Date="@view.param.pData_End" />                                            

                                                </div>
                                           }

                                           <div class="form-group">
                                                <label class="form-label">@view.texts.SearchByRecordID_Label:</label>
                                                <input type="text" class="form-control" maxlength="20" @bind-value="@view.param.pDataLogID">
                                                
                                           </div>

                                           <p class="field" style="padding-top:10px">

                                                  <TaskButton @ref="searchbtn" OnClick="OnSearch" Title=@view.texts.SearchButtonLabel                                                         
                                                          ReadOnly=!view.Permissions.AllowRead
                                                         ActionLabel=@view.texts.SearchingLabel>
                                                </TaskButton>

                                            </p>

                                    </div>
							   </div>
                             </div>
                                                            
                            <div class="col-xl-8">

                                <div class="card card-flush h-xl-100">
										
									<div class="card-header pt-7">
											
										<h3 class="card-title align-items-start flex-column">
                                        <span class="card-label fw-bold text-dark">@view.texts.SearchResultLabel</span>
                                    </h3>
                                    </div>

                                    <div class="card-body">
                                            
                                            @if (view.searchresult != null)
                                            {
                                                @if (view.searchresult.Count > 0)
                                                {
                                                       <DataGrid TItem="DataLogResult" Data="@view.searchresult"  Responsive  ShowPager PageSize=10 >                                                                                         
                                             
                                                            <DataGridColumns>

                                                                <DataGridColumn Field="@nameof(DataLogResult.Email)" Caption=@view.texts.Email_Label />
                                                                <DataGridColumn Field="@nameof(DataLogResult.TableName)" Caption=@view.texts.TableName_Label />
                                                                <DataGridColumn Field="@nameof(DataLogResult.OperationText)" Caption=@view.texts.OperationText_Label />
                                                                <DataGridColumn Field="@nameof(DataLogResult.Date)" Caption=@view.texts.Date_Label />
                                                                <DataGridColumn Field="@nameof(DataLogResult.DataLogID)" Caption=@view.texts.DetailsLabel>
                                                                    <DisplayTemplate>
                                                                         @{
                                                                                DataLogResult obj = (context as DataLogResult);
                                                                               
                                                                                @if(view.Permissions.AllowSave)
                                                                                {
                                                                                    <IconButton Icon="IconButton.TYPEICONENUM.DETAILS" 
                                                                                            OnClick="()=>OnDetClick(obj.DataLogID)"></IconButton>                                                                                                                                                   
                                                                                }
                                                                          

                                                                            }
                                                    
                                                                    </DisplayTemplate>
                                                                </DataGridColumn>
                                            
                                                                </DataGridColumns>
                                      
                                                        </DataGrid>
                                    
                                                }
                                                else
                                                {
                                                    <p> @view.texts.NoRecordsFound </p>
                                                }
                                            }
                                         
                                    </div>

                                </div>
                                                                  

                            </div>

                           
                        </div>

                    </div>                       

                    <div style="display:@view.EditingState">
                            
                        <BackButton OnClick="Back"></BackButton>
                                              
                         <div class="row gy-5 g-xl-10">

                                <div class="col-xl-12">                                
                                    <div class="card card-flush h-xl-100">								      
		                                <div class="card-header pt-7">
									  
			                                <h3 class="card-title align-items-start flex-column">
                                        <span class="card-label fw-bold text-dark">@view.texts.DetailsLabel</span>
                                    </h3>									        
									       
                                        </div>
                                           
                                        <div class="card-body">										                                                                                                                                                                                                                      
                                              <div class="row">

                                                    <div class="col-md-3">
                                                        <div class="form-group">
                                                            <label class="form-label">@view.texts.LogID_Label:</label>
                                                            <input type="text" value="@view.result.DataLogID" class="form-control" disabled />
                                                        </div>
                                                    </div>

                                                    <div class="col-md-8">
                                                        <div class="form-group">
                                                            <label class="form-label">@view.texts.LogInformation_Label:</label>
                                                            <input type="text" value="@view.result.TableName | @view.result.OperationText | @view.result.Date | @view.result.Email"
                                                                   class="form-control" disabled />
                                                        </div>
                                                    </div>

                                                    <div class="col-md-1" >
                                                                                                                        
                                                        <div class="mr-2" style="padding-bottom:5px">
                                                            <button type="button" class="btn btn-light-primary me-3"  @onclick="OnGetTimeline">
                                                                <span class="svg-icon svg-icon-4 me-1">
                                                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                        <path opacity="0.3" d="M21.25 18.525L13.05 21.825C12.35 22.125 11.65 22.125 10.95 21.825L2.75 18.525C1.75 18.125 1.75 16.725 2.75 16.325L4.04999 15.825L10.25 18.325C10.85 18.525 11.45 18.625 12.05 18.625C12.65 18.625 13.25 18.525 13.85 18.325L20.05 15.825L21.35 16.325C22.35 16.725 22.35 18.125 21.25 18.525ZM13.05 16.425L21.25 13.125C22.25 12.725 22.25 11.325 21.25 10.925L13.05 7.62502C12.35 7.32502 11.65 7.32502 10.95 7.62502L2.75 10.925C1.75 11.325 1.75 12.725 2.75 13.125L10.95 16.425C11.65 16.725 12.45 16.725 13.05 16.425Z" fill="currentColor"></path>
                                                                        <path d="M11.05 11.025L2.84998 7.725C1.84998 7.325 1.84998 5.925 2.84998 5.525L11.05 2.225C11.75 1.925 12.45 1.925 13.15 2.225L21.35 5.525C22.35 5.925 22.35 7.325 21.35 7.725L13.05 11.025C12.45 11.325 11.65 11.325 11.05 11.025Z" fill="currentColor"></path>
                                                                    </svg>
                                                                </span>
                                                                @view.texts.ShowTimeLine_Label
                                                            </button>
                                                        </div>
                                                                                                                                                                         
                                                    </div>

                                            </div>     

                                            @if (!view.ShowTimeline)
                                             {
                                                <div class="row" style="margin-top: 15px">
                                                    <div class="col-lg-6">

                                                       <h5>@view.texts.OldVersionData_Label</h5>

                                                        @if (view.logold_content != null)
                                                        {
                                                            @if (view.logold_content.Count > 0)
                                                            {
                                                                    <DataGrid TItem="DataLogItem" Data="@view.logold_content"  Responsive >                                                                                         
                                             
                                                                        <DataGridColumns>
                                                                                <DataGridColumn Field="@nameof(DataLogItem.ItemName)" Caption=@view.texts.Field_Label />
                                                                                <DataGridColumn Field="@nameof(DataLogItem.ItemValue )" Caption=@view.texts.Value_Label />

                                                                        </DataGridColumns>
                                      
                                                                    </DataGrid>
                                      
                                                            }
                                                            else
                                                            {
                                                                <p> @view.texts.HasNoOldVersion_Label </p>
                                                            }
                                                        }

                                                  </div>

                                                    <div class="col-lg-6">
                                                        <h5>@view.texts.CurrentVersionData_Label</h5>

                                                        @if (view.logcurrent_content != null)
                                                        {
                                                            @if (view.logcurrent_content.Count > 0)
                                                            {
                                                                <DataGrid TItem="DataLogItem" Data="@view.logcurrent_content"  Responsive >                                                                                         
                                             
                                                                        <DataGridColumns>
                                                                                 <DataGridColumn Field="@nameof(DataLogItem.ItemName)" Caption=@view.texts.Field_Label />

                                                                                    <DataGridColumn Field="@nameof(DataLogItem.ItemValue)" Caption=@view.texts.DetailsLabel>
                                                                                    <DisplayTemplate>
                                                                                            @{
                                                                                                DataLogItem obj = (context as DataLogItem);
                                                                                                string color = "black";
                                                                                                string bold = "bold";
                                                                                                if (obj.IsDifferent)
                                                                                                {
                                                                                                    color = "red";
                                                                                                    bold = "bold";
                                                                                                }
                                                                                                <span style="color:@color;font-weight:@bold"> @obj.ItemValue </span>
                                                                                            }
                                                    
                                                                                    </DisplayTemplate>
                                                                                </DataGridColumn>
                                            
                                                                            </DataGridColumns>
                                      
                                                                 </DataGrid>
                                    
                                                            }
                                                            else
                                                            {
                                                                 <p> @view.texts.HasNoCurrentVersion_Label  </p>
                                                            }
                                                        }

                                                    </div>

                                                </div>
                                                }
                                                else
                                                {
                                                     <div class="row" style="margin-top: 15px">
                                                        <div class="col-lg-12">

                                                            <h5>@view.texts.ShowTimeLine_Label </h5>

                                                            @if (view.timeline != null)
                                                            {
                                                                @if (view.timeline.Count > 0)
                                                                {
                                                                        <DataGrid TItem="DataLogTimelineModel" Data="@view.timeline"  Responsive >                                                                                         
                                             
                                                                            <DataGridColumns>
                                                                                    <DataGridColumn Field="@nameof(DataLogTimelineModel.Date)" Caption=@view.texts.Date_Label />
                                                                                    <DataGridColumn Field="@nameof(DataLogTimelineModel.OperationText )" Caption=@view.texts.Value_Label />
                                                                                    <DataGridColumn Field="@nameof(DataLogTimelineModel.UserEmail )" Caption=@view.texts.Email_Label /> 
                                                                                </DataGridColumns>
                                      
                                                                        </DataGrid>                                        
                                                                }
                                                                else
                                                                {
                                                                    <p> @view.texts.HasNoTimeLine_Label  </p>
                                                                }
                                                            }


                                                        </div>
                                                    </div>
                                                }
                                               
                                        </div>
		                            </div>
                                </div>
                                                                                         
                           
                            </div>                                                                                                            

                    </div>
                }
                else
                {
                   <img src="../images/circle_loader.gif" style="width:32px;height:32px" />

                }
            </div>
        </div>
   </div>




@code {
    
    private MessageBox msgbox;  
    private TaskLoading loading;
    private TaskButton searchbtn;
    private TaskIconButton timelinebtn;

    private string _LoadingData_Text;
    private string _PageTitle;
  

    //

    private UserAuthenticated LoggedUser;
    private DataLogViewModel view;
   
    //

    private async Task InitResources()
    {        
        ((TemplateAppController)_appctrl).Settings = _settings;

        if (await _appctrl.IsAuthenticated())
        {
            LoggedUser = _appctrl.UserInfo;
            _memberservices.Init(_httpclient,_settings.ServiceURL,LoggedUser.Token);
            _cacheservices.Init(_httpclient,_settings.ServiceURL,LoggedUser.Token);
            view = new DataLogViewModel((_memberservices as MembershipGateway) ,
               (_cacheservices as DataCacheGateway), LoggedUser);

            List<UserPermissions> list = await _appctrl.GetUserPermissions(LoggedUser.Token);
            view.Permissions
                = BaseViewModel.SetPermissions(list, "SYSDATALOG", false);
        }

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        if (firstRender)
        {
            await InitResources();
            await view.InitializeModels();
            await view.LoadTipoOperacaoList((_cacheservices as DataCacheGateway));
            await view.LoadTabelaList((_cacheservices as DataCacheGateway));

            _LoadingData_Text = view.texts.LoadingData;
            _PageTitle = view.texts.DataLog_PageTitle;

            StateHasChanged();
        }
    }

    public async Task OnSearch()
    {
        searchbtn.Begin(); 
        await view.Search();

        if (!view.ExecutionStatus.Status)
        {
            await msgbox.ShowDialog(view.texts.ErrorOnExecuteSearch, view.ExecutionStatus.Error.Message);
        }

        searchbtn.End();
    }

    public void OnNew()
    {

        view.InitNew(); 
        StateHasChanged();
    }

    public async Task OnGet(object id)
    {
        await loading.Begin() ;

        await view.Get(id);

        await loading.End();

        if (!view.ExecutionStatus.Status)
        {
            await msgbox.ShowDialog(view.texts.ErrorOnReturnData, view.ExecutionStatus.Error.Message);
        }
        else
        {
            view.InitEdit(); 

        }

        StateHasChanged();
    }

    public async Task OnGetTimeline()
    {
        
        await view.GetTimeline();

        if (!view.ExecutionStatus.Status)
        {
            await msgbox.ShowDialog(view.texts.ErrorOnReturnData, view.ExecutionStatus.Error.Message);
            view.ShowTimeline = false; 
        }
        else
        {
            view.ShowTimeline = true; 
        }
       
    }
    

    public async Task OnDetClick(object id)
    {        
        await OnGet(id);

    }

    public void Back()
    {
        view.BackToSearch(); 
        StateHasChanged();

    }

    public void GoHome()
    {
        string url = _appctrl.UserInfo.HomeURL;
        NavigationManager.NavigateTo(url);

    }


    //public string GetImageUrl(string filename)
    //{
    //    string ret = "";

    //    ret = ((TemplateAppController)_appctrl).GetProfileImageURL(filename);

    //    return ret;
    //}


}
